---
title: youRfan (4) &#58; Docker NGINX (REACT + DJANGO)
tags: [Sparta, Docker, React, Django]
sidebar:
  nav: categories
permalink: "/categories/sparta/projects/yourfan_4"
---

<div class="article__content" markdown="1">

&ensp; í˜„ì¬ ì›ë˜ í”„ë¡œì íŠ¸ì—ì„œ ì˜ì¡´ì„± ì˜¤ë¥˜ë¡œ ë°±ì—”ë“œê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤. ë”êµ°ë‹¤ë‚˜ ì£¼ë§ì¸ì§€ë¼ ì‰¬ê³  ìˆëŠ” íŒ€ì›ë“¤ì—ê²Œ ë‹¥ë‹¬í•  ìˆ˜ë„ ì—†ëŠ” ìƒí™©ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ í˜¼ìì„œ ê°„ë‹¨í•˜ê²Œ ë¦¬ì•¡íŠ¸ì™€ ì¥ê³  í™˜ê²½ì„ êµ¬ì¶•í•˜ì—¬ ì—”ì§€ë‹‰ìŠ¤(NGINX)ë¥¼ í†µí•´ ë¡œì»¬ì—ì„œ ë„ì»¤ë¡œ ë°°í¬í•´ë³´ê³ ì í•©ë‹ˆë‹¤.

---

## âœ… ì›Œí¬í”Œë¡œìš°

### ì›Œí¬í”Œë¡œìš°

![NGINX Workflow with React & Django](/assets/images/sparta/projects/yourfan/yourfan_3.png)

### íŒŒì¼ì‹œìŠ¤í…œ

```zsh
root
â”œâ”€â”€ django-app
â”œâ”€â”€ react-app
â”œâ”€â”€ nginx
â”‚   â””â”€â”€ custom.conf
â””â”€â”€ docker-compose.yaml
```

<br/>

## âœ… ì¥ê³  ë°±ì—”ë“œ

### ì›í™œí•œ ë°°í¬ë¥¼ ìœ„í•œ ìµœì†Œí•œì˜ íŒ¨í‚¤ì§€ë“¤

- `django`, `django-storages`, `django-dotenv`, `gunicorn`, `psycopg2-binary` (or `psycopg2-binary`)

### ë„ì»¤ íŒŒì¼

```zsh
FROM python:3.10-slim

EXPOSE 8000

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app
COPY . .

# psycopg2 ì„¤ì¹˜ì— í•„ìš”í•œ ë¦¬ëˆ…ìŠ¤ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*


# ë¡œì»¬ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ê°€ìƒ í™˜ê²½ì„ ìƒì„±í•˜ì—¬ ì˜ì¡´ì„± ê´€ë¦¬
RUN /opt/venv/bin/pip install pip --upgrade && \
    /opt/venv/bin/pip install -r requirements.txt && \
    chmod +x entrypoint.sh

CMD ["/app/entrypoint.sh"]
```

- ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¡œ `3.10-slim`ì„ ì„ íƒ (ê°€ëŠ¥í•˜ë‹¤ë©´ `alphine`ìœ¼ë¡œ êµì²´ ì˜ˆì •)

- postgres ì–´ëŒ‘í„°ì˜ ê²½ìš°, ê°œë°œ ë‹¨ê³„ì—ì„œëŠ” psycopg2-binaryë¥¼, ë°°í¬ ë‹¨ê³„ì—ì„œëŠ” psycopg2ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥

### entrypoint.sh

```bash
#!/bin/bash
APP_PORT=${PORT:-8000}
cd /app/

/opt/venv/bin/gunicorn --worker-tmp-dir /dev/shm config.wsgi:application --bind "0.0.0.0:${APP_PORT}"
```

- _entrypoint.sh_ - `gunicorn` ì•± ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼
- ë„ì»¤ íŒŒì¼ì—ì„œ `chmod +x entrypoint.sh`ë¡œ í•´ë‹¹ íŒŒì¼ì— ëŒ€í•œ ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬
- `cd /app/` - ì•± ì‹¤í–‰ì€ í”„ë¡œì íŠ¸ í´ë” ì•ˆì—ì„œ ê°€ëŠ¥
- `#!/bin/bash` - ë°°ì‰¬ ìŠ¤í¬ë¦½íŠ¸ì„ì„ ëª…ì‹œ (ë‹¨ìˆœ ì£¼ì„/í…ìŠ¤íŠ¸ íŒŒì¼)
- `--worker-tmp-dir /dev/shm` - ì˜µì…˜

### migrate.sh

```bash
#!/bin/bash
SUPERUSER_EMAIL=${DJANGO_SUPERUSER_EMAIL:-"admin@test.com"}
cd /app/

/opt/venv/bin/python manage.py migrate --noinput
/opt/venv/bin/python manage.py createsuperuser --email $SUPERUSER_EMAIL --noinput || true
```

- _migrate.sh_ - Migrateë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼
- `|| true`: `||` ì´ì „ ëª…ë ¹ì–´ê°€ ì‹¤íŒ¨í•˜ë”ë¼ë„ ì˜¤ë¥˜ë¥¼ ë°œìƒì‹œí‚¤ì§€ ì•ŠìŒ
- ìœ„ì˜ ëª…ë ¹ì–´ë“¤ì€ DBì™€ ì§ì ‘ ê´€ê³„í•˜ê¸° ë•Œë¬¸ì— ì–´ë””ì„œ ì‹¤í–‰í•˜ëŠ”ì§€ê°€ ì¤‘ìš”
  - `python manage.py makemigrations`
  - `python manage.py migrate --noinput`
  - `python manage.py createsuperuser --email MY_EMAIL --noinput`
- `python manage.py collectstatic --noinput`ì€ DBì™€ ì§ì ‘ ê´€ê³„í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì–´ë””ì„œ ì‹¤í–‰í•˜ëŠ”ì§€ ì¤‘ìš” âŒ
- ìš”ì»¨ëŒ€, *migrate.sh*ëŠ” DB ì»¨í…Œì´ë„ˆê°€ ìƒì„±ëœ í›„ì— ì‹¤í–‰ë˜ì–´ì•¼ í•˜ë©°, ì´ë¥¼ ìœ„í•´ ë„ì»¤ ì»´í¬ì¦ˆ íŒŒì¼ì—ì„œ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰
- _docker-compose.yaml_ ë‚´ ì„œë¹„ìŠ¤ì˜ `command` ì†ì„±ì— ë‹¤ìŒì˜ ì½”ë“œë¥¼ ì¶”ê°€
  ```yaml
  command: sh -c "chmod +x /app/migrate.sh && sh /app/migrate.sh && /app/entrypoint.sh"
  ```

<br/>

## âœ… ë¦¬ì•¡íŠ¸ í”„ë¡ íŠ¸ì—”ë“œ

### ë„ì»¤ íŒŒì¼

```zsh
FROM node:lts-alpine3.18

WORKDIR /app

COPY package.json .
RUN npm install --silent

COPY . .

ARG REACT_APP_NAME
ENV REACT_APP_NAME=${REACT_APP_NAME}
RUN npm run build
```

- _build_ í´ë”ë¥¼ ìƒì„±í•œ ë’¤ì—, í•´ë‹¹ í´ë”ë¥¼ NGINX ì»¨í…Œì´ë„ˆì˜ ë³¼ë¥¨ìœ¼ë¡œ ì§€ì •

<br/>

## âœ… ì—”ì§€ë‹‰ìŠ¤

```conf
upstream api {
    server backend:8000;
}

server {
    listen 80;

    location / {
        root    /var/www/react;
        index   index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://api
        proxy_set_header Host $http_host;
    }
}
```

- ë¦¬ì•¡íŠ¸ ì»¨í…Œì´ë„ˆì˜ _build_ í´ë”ë¥¼, ì—”ì§€ë‹‰ìŠ¤ ì»¨í…Œì´ë„ˆì˜ _/var/www/react_ ê²½ë¡œì— ë³¼ë¥¨ìœ¼ë¡œ ì§€ì •

## âœ… docker-compose.yaml

```yaml
version: "3.8"

services:
  backend:
    build:
      context: ./django-app
    ports:
      - 8000:8000
    command: sh -c "chmod +x /app/migrate.sh && sh /app/migrate.sh && /app/entrypoint.sh"
    container_name: backend
  frontend:
    stdin_open: true
    build:
      context: ./react-app
      args:
        - REACT_APP_NAME=REACT
    volumes:
      - react_build:/app/build
    container_name: frontend
  nginx:
    image: nginx:stable-alpine-slim
    ports:
      - 80:80
    volumes:
      - ./nginx/custom.conf:/etc/nginx/conf.d/default.conf:ro
      - react_build:/var/www/react
    depends_on:
      - backend
      - frontend
    container_name: nginx

volumes:
  react_build:
```

<br/>

## ğŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…: Container Exited (0)

![Closed Container with Error 'Exited (0)'](/assets/images/sparta/projects/yourfan/yourfan_4.png)

&ensp; `docker compose run`ì„ ì‹¤í–‰í–ˆë”ë‹ˆ, ìê¾¸ `frontend` ì»¨í…Œì´ë„ˆê°€ ì¢…ë£ŒëìŠµë‹ˆë‹¤. ì›ì¸ì€ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìœ¼ë©´ ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œì‹œí‚¤ëŠ” ë„ì»¤ ì»¨í…Œì´ë„ˆì˜ ephemeralí•œ íŠ¹ì„± ë•Œë¬¸ì´ì—ˆìŠµë‹ˆë‹¤. ì¦‰, í˜„ì¬ ë¦¬ì•¡íŠ¸ ë„ì»¤ íŒŒì¼ì€ `npm run build` ëª…ë ¹ë§Œì„ ìˆ˜í–‰í•˜ê²Œ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œë˜ë©´ ì»¨í…Œì´ë„ˆë„ ê°™ì´ ì¢…ë£Œë©ë‹ˆë‹¤.

&ensp; ì—”ì§€ë‹‰ìŠ¤ëŠ” ë¦¬ì•¡íŠ¸ ì»¨í…Œì´ë„ˆìƒì˜ _build_ í´ë”ë¥¼ ë³¼ë¥¨ìœ¼ë¡œ ë³´ê³  ìˆê¸° ë•Œë¬¸ì—, ë¦¬ì•¡íŠ¸ ì»¨í…Œì´ë„ˆê°€ ë‹¤ìš´ë˜ë©´ ì—”ì§€ë‹‰ìŠ¤ëŠ” ì •ì  íŒŒì¼ì„ í´ë¼ì´ì–¸íŠ¸í•œí…Œ ì „ë‹¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ, ë¦¬ì•¡íŠ¸ ì»¨í…Œì´ë„ˆê°€ ë” ì´ìƒ ì‹¤í–‰í•  ëª…ë ¹ì–´ê°€ ì—†ë”ë¼ë„ ì¢…ë£Œë˜ì§€ ì•Šê²Œ í•  í•„ìš”ê°€ ìˆìŠµë‹ˆë‹¤.

&ensp; ì´ë•Œ, ì„œë¹„ìŠ¤ì— `tty` ë˜ëŠ” `stdin_open` ì†ì„±ì„ ì¶”ê°€í•˜ë©´ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œë˜ì§€ ì•Šê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```yaml
# docker-compose.yaml
version: "3.8"

services:
  backend:
    ...
  frontend:
    # tty: true
    stdin_open: true
    ...

```

<br/>

## âœ… ê²°ê³¼

![React Home Screen](/assets/images/sparta/projects/yourfan/yourfan_5.png)

&ensp; 80ë²ˆ í¬íŠ¸ë¡œ ì •ìƒ ì—°ê²°ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</div>
