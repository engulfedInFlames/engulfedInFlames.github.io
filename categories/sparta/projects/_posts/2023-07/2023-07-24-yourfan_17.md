---
title: "youRFan (17) : ì†Œì…œ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ ë¦¬íŒ©í† ë§í•˜ê¸°"
tags: [Sparta, DRF]
sidebar:
  nav: categories
permalink: "/categories/sparta/projects/yourfan_17"
---

<div class="article__content" markdown="1">

&ensp; ë¶€íŠ¸ ìº í”„ê°€ ëë‚¬ê³ , ì´ë ¥ì„œ ì‘ì„±ë„ ì¼ë‹¨ ì™„ë£ŒëìŠµë‹ˆë‹¤. í•œ ì¤„ì´ë¼ë„ ë” ì¨ë†“ì„ë ¤ë©´ ê±°ë¦¬ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ì´ì œ ì™„ì„±ëœ í”„ë¡œì íŠ¸ë¥¼ ì¡°ê¸ˆì”© ë¦¬íŒ©í† ë§í•˜ê³ , ê¸°ëŠ¥ì„ ê³ ë„í™”í•˜ê² ìŠµë‹ˆë‹¤.

---

## âœ… ì†Œì…œ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ ë¦¬íŒ©í† ë§

### í˜„ì¬ ìƒí™©

&ensp; í˜„ì¬ ì†Œì…œ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ëŠ” ëª¨ë“ˆí™”ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©°, ë³´ì¼ëŸ¬í”Œë ˆì´íŠ¸ë¡œ ì‘ì„±ë˜ì–´ ëŒ€ëµ 300ì¤„ì˜ ì½”ë“œë¥¼ ì°¨ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì˜ˆë¡œ, YouRFanì˜ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ì˜ ë¡œì§ì„ ì‚´í”¼ë©´, ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```python
# í”„ë¡ íŠ¸ë¡œë¶€í„° ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ API í˜¸ì¶œì„ ìœ„í•œ í† í°(code)ì„ ë°›ìŒ
code = request.data.get("code")
url = "https://kauth.kakao.com/oauth/token"
redirect_uri = KAKAO_REIDRECT_URI

# ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ APIë¥¼ í˜¸ì¶œ
response = requests.post(
            url,
            data={
                ...
                "code": code,
            },
            headers={
                ...
            },
        )

...

user_data = response.json()
kakao_account = user_data.get("kakao_account")
user_email = kakao_account.get("email")
try:
    # ê°€ì…ëœ ì´ë©”ì¼ì´ë¼ë©´ ê³§ë°”ë¡œ ë¦¬ìŠ¤í°ìŠ¤ë¡œ ì•¡ì„¸ìŠ¤ í† í°ì„ ì „ë‹¬
    ...
except:
    # ê°€ì…ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì´ë¼ë©´ ìœ ì € ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ì•¡ì„¸ìŠ¤ í† í°ì„ ì „ë‹¬
    ...
```

&ensp; í”„ë¡ íŠ¸ì—ì„œ ì½”ë“œë‚˜ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°›ê³  ë‚˜ì„œ ìœ ì €ë¥¼ ë¡œê·¸ì¸ì‹œí‚¤ê¸°ê¹Œì§€ ëª¨ë“  ê³¼ì •ì´ ê°ê°ì˜ ì†Œì…œ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ì— êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

&ensp; ìµœëŒ€í•œ ì¶”ìƒí™”í•œë‹¤ë©´, ë¦¬í€˜ìŠ¤íŠ¸ ë°ì´í„°ë¡œ ì†Œì…œ ë¡œê·¸ì¸ì˜ ìœ í˜•ì„ ë°›ì•„, í•˜ë‚˜ì˜ ì†Œì…œ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ì—ì„œ ì–´ë–¤ ì†Œì…œ ë¡œê·¸ì¸ì„ ì‹œí‚¬ ê²ƒì¸ì§€ êµ¬ë¶„í•˜ê²Œ í•  ìˆ˜ë„ ìˆì„ ê²ƒì…ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ë¬´ì¡°ê±´ì ì¸ ì¶”ìƒí™”ê°€ ë°”ëŒì§í•˜ë‹¤ê³  ìƒê°í•˜ì§€ëŠ” ì•Šìœ¼ë©°, ë””ë²„ê¹…ì— ì–´ë ¤ì›€ì´ ë”°ë¥¼ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ, ë·° í´ë˜ìŠ¤ ìì²´ëŠ” ìœ í˜•ë³„ë¡œ ë‚˜ëˆ„ê² ìŠµë‹ˆë‹¤. ì¦‰, ê¸°ì¡´ëŒ€ë¡œ ì¹´ì¹´ì˜¤, ê¹ƒí—ˆë¸Œ, êµ¬ê¸€ ì´ 3ê°œì˜ ë·° í´ë˜ìŠ¤ë¥¼ ì •ì˜í•  ê²ƒì…ë‹ˆë‹¤. ëŒ€ì‹  ë·° í´ë˜ìŠ¤ ë‚´ë¶€ ë¡œì§ì˜ ê³µí†µ íŒ¨í„´ì„ íŒŒì•…í•˜ì—¬ ì´ë¥¼ ëª¨ë“ˆí™”í•˜ê² ìŠµë‹ˆë‹¤.

&ensp; ì†Œì…œ ë¡œê·¸ì¸ êµ¬í˜„ ê³¼ì •ì€ ëŒ€ê²Œ ë¹„ìŠ·í•©ë‹ˆë‹¤. íŒ¨í„´ë§Œ íŒŒì•…í•˜ë©´, ëª¨ë“ˆí™”í•˜ì—¬ ë·° í´ë˜ìŠ¤ë¥¼ ë‹¨ìˆœí™”í•˜ê³  ì½”ë“œ í’ˆì§ˆì„ ë†’ì¼ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

### ë¡œì§ íŒ¨í„´í™”

&ensp; ì†Œì…œ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ì—ëŠ” ë‹¤ìŒì˜ 3ê°€ì§€ ê³µí†µ íŒ¨í„´ì´ ìˆìŠµë‹ˆë‹¤.

1. í”„ë¡ íŠ¸ë¡œë¶€í„° API ìš”ì²­ì„ ìœ„í•œ ì•¡ì„¸ìŠ¤ í† í°ì„ ì „ë‹¬ ë°›ê¸°
2. API ìš”ì²­ì„ í†µí•´ ìœ ì €ì˜ ì†Œì…œ ê³„ì • ë°ì´í„° ì–»ê¸°
3. ì–»ì€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìœ ì €ë¥¼ ë¡œê·¸ì¸ì‹œí‚¤ê¸°

&ensp; ê° íŒ¨í„´ ë§ˆë‹¤ ë©”ì†Œë“œë¥¼ ì •ì˜í•˜ëŠ” ê²ƒì´ ì´ìƒì ì¼ ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ì„œëŠ” 1~2ë²ˆ íŒ¨í„´ì„ í†µí•©í•˜ì—¬ í•˜ë‚˜ì˜ ë©”ì†Œë“œë§Œì„ ì •ì˜í•  ê²ƒì´ê³ , ê° ë©”ì†Œë“œì˜ ì´ë¦„ì€ `get_user_data_from_kakao`, `get_user_data_from_github`, `get_user_data_from_google`ì…ë‹ˆë‹¤. ì´ `get_user_data` ë©”ì†Œë“œëŠ” API ìš”ì²­ìœ¼ë¡œ ìœ ì €ì˜ ì´ë©”ì¼, ë‹‰ë„¤ì„, ì•„ë°”íƒ€ ë°ì´í„°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìœ ì €ë¥¼ ë¡œê·¸ì¸ì‹œí‚¤ëŠ” ë©”ì†Œë“œëŠ” í•œ ê°€ì§€ë¡œ ì¡±í•˜ë©°, ë©”ì†Œë“œ ì´ë¦„ì€ `get_or_create_social_user`ë¡œ í•˜ê² ìŠµë‹ˆë‹¤. ë§Œì•½ íšŒì› ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ íšŒì› ë“±ë¡ì„ í•´ì•¼ í•˜ë¯€ë¡œ, `create_social_type_user`ë¼ëŠ” íšŒì› ë“±ë¡ ë©”ì†Œë“œë„ ì •ì˜í•˜ê² ìŠµë‹ˆë‹¤.

### ë·° í´ë˜ìŠ¤ ì •ì˜

```python
class KakaoLogin(APIView):
    def post(self, request):
        code = request.data.get("code")
            try:
                token_data = get_or_create_social_user(code, "kakao")
                return Response(
                    data=token_data,
                    status=status.HTTP_200_OK,
                )
            except exceptions.ValidationError as err:
                return Response(
                    data={"error_message": str(err)},
                    status=status.HTTP_400_BAD_REQUEST,
                )
```

&ensp; ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë·° í´ë˜ìŠ¤ë¥¼ ìœ„ì™€ ê°™ì´ ì •ì˜í–ˆìŠµë‹ˆë‹¤. 100ì¤„ì— ê°€ê¹Œìš´ ì½”ë“œê°€ 15ì¤„ë¡œ ì¤„ì—ˆìŠµë‹ˆë‹¤. `get_or_create_social_user`ì— ì²« ë²ˆì§¸ ì¸ìë¡œ ì½”ë“œ(ë˜ëŠ” ì•¡ì„¸ìŠ¤ í† í°)ì„, ë‘ ë²ˆì§¸ ì¸ìë¡œ ì†Œì…œ ë¡œê·¸ì¸ ìœ í˜•ì„ ì „ë‹¬í•©ë‹ˆë‹¤. `get_or_create_social_user`ëŠ” ë‘ ë²ˆì§¸ ì¸ìë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì–´ë–¤ ì†Œì…œ ë¡œê·¸ì¸ ë©”ì†Œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë˜ëŠ”ì§€ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.

### ë©”ì†Œë“œ ì •ì˜

#### get_or_create_social_user

```python

method_type = {
    "kakao": get_user_data_from_kakao,
    "github": get_user_data_from_github,
    "google": get_user_data_from_google,
}

def get_or_create_social_user(access_token, social_type):
    get_user_data = method_type.get(social_type)
    user_data = get_user_data(access_token)
    email, nickname, avatar = user_data.values()
    try:
        user = CustomUser.objects.get(email=email)
        if user.is_active == False:
            raise exceptions.ValidationError("ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤")
        return get_token_data(user)

    except CustomUser.DoesNotExist:
        user = create_social_type_user(
            email=email,
            nickname=nickname,
            avatar=avatar,
            type="kakao",
        )
        return get_token_data(user)
```

&ensp; `get_or_create_social_user` ì´í•˜ì˜ ë©”ì†Œë“œì—ì„œëŠ” ì˜ˆì™¸ ìƒí™© ë°œìƒì‹œ ëª¨ë‘ `ValidationError`ë¥¼ ì¼ìœ¼í‚¤ê²Œ í•  ê²ƒì…ë‹ˆë‹¤. `ValidationError`ê°€ ì¼ì–´ë‚˜ë©´, ë·° í´ë˜ìŠ¤ì˜ `except`ì—ì„œ ì˜ˆì™¸ ì²˜ë¦¬ë©ë‹ˆë‹¤.

&ensp; Dict ìë£Œí˜• `method_type`ì—ì„œëŠ” `social_type`ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì†Œë“œë¥¼ í• ë‹¹í•©ë‹ˆë‹¤. í• ë‹¹ëœ `get_user_data`ëŠ” ìµœì¢…ì ìœ¼ë¡œ ìœ ì €ì˜ `email`, `nickname`, `avatar` ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ë©°, ë°ì´í„°ê°€ ì—†ì„ ë•ŒëŠ” `None`ì„ ë°˜í™˜í•©ë‹ˆë‹¤. `get_user_data_from_kakao` ë©”ì†Œë“œë¡œ ì˜ˆë¥¼ ë“¤ê² ìŠµë‹ˆë‹¤.

### get_user_data_from_kakao

```python
def get_user_data_from_kakao(code):
    # ìœ ì €ì˜ ì¹´ì¹´ì˜¤ ê³„ì •ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ ì•¡ì„¸ìŠ¤ í† í°ì„ ë°œê¸‰ ë°›ìŒ
    url = "https://kauth.kakao.com/oauth/token"
    redirect_uri = KAKAO_REDIRECT_URI
    response = requests.post(
        url=url,
        data={
            ...
            "code": code,
        },
        headers={"Content-type": "application/x-www-form-urlencoded;charset=utf-8"},
    )
    access_token = response.json().get("access_token")

    # ë°œê¸‰ ë°›ì€ ì•¡ì„¸ìŠ¤ í† í°ìœ¼ë¡œ ìœ ì €ì˜ ì¹´ì¹´ì˜¤ ê³„ì • ë°ì´í„°ë¥¼ ë°›ìŒ
    url = "https://kapi.kakao.com/v2/user/me"
    response = requests.get(
        url=url,
        headers={
            ...
            "Content-type": "application/x-www-form-urlencoded;charset=utf-8",
        },
    )

    # ë°›ì€ ê³„ì • ë°ì´í„°ë¡œë¶€í„° í•„ìš”í•œ ë°ì´í„°ë¥¼ ì¶”ì¶œ
    user_data = response.json()
    kakao_account = user_data.get("kakao_account")
    profile = kakao_account.get("profile")
    user_email = kakao_account.get("email")
    is_verified_email = kakao_account.get("is_email_valid") and kakao_account.get(
        "is_email_verified"
    )

    # email, nickname, avatarë¥¼ ë°˜í™˜
    return {
        "email": user_email,
        "nickname": profile.get("nickname", None),
        "avatar": profile.get("thumbnail_image_url", None),
    }
```

### create_social_type_user

```python
def get_or_create_social_user(access_token, social_type):
    get_user_data = method_type.get(social_type)
    user_data = get_user_data(access_token)
    email, nickname, avatar = user_data.values()
    try:
        # íšŒì›ì„ ì°¾ì§€ ëª»í•˜ë©´ DoesNotExist ì—ëŸ¬ê°€ ë°œìƒ
        user = CustomUser.objects.get(email=email)
        if user.is_active == False:
            raise exceptions.ValidationError("ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤")
        return get_token_data(user)

    except CustomUser.DoesNotExist:
        # íšŒì›ë“±ë¡ì„ ìœ„í•œ ë©”ì†Œë“œ
        user = create_social_type_user(
            email=email,
            nickname=nickname,
            avatar=avatar,
            type="kakao",
        )
        return get_token_data(user)
```

&ensp; ë°˜í™˜ëœ `email`ë¡œ ê°€ì…í•œ ê¸°ë¡ì´ ì—†ë‹¤ë©´ íšŒì›ë“±ë¡ì„ í•´ì•¼ í•©ë‹ˆë‹¤. `create_social_type_user` ë©”ì†Œë“œê°€ ê·¸ ì—­í• ì„ í•©ë‹ˆë‹¤. ìµœì¢…ì ìœ¼ë¡œëŠ” `get_token_data` ë©”ì†Œë“œê°€ í˜¸ì¶œë˜ë©°, í•´ë‹¹ ë©”ì†Œë“œëŠ” JWT í† í°ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

```python
def create_social_type_user(email, nickname, avatar, type):
    user = CustomUser.objects.create_user(email=email)
    user.nickname = nickname or f"user#{user.pk}"
    user.avatar = avatar
    ...
    user.save()

    return user
```

<br/>

## âœ… ê²°ë¡ 

&ensp; ì†Œì…œ ë¡œê·¸ì¸ì— ëŒ€í•œ ë¦¬íŒ©í† ë§ì´ ì™„ë£ŒëìŠµë‹ˆë‹¤. ì´ì œ ìƒˆë¡œìš´ ì†Œì…œ ë¡œê·¸ì¸ì´ ì¶”ê°€ë  ë•Œë§ˆë‹¤ ëŒ€ëµ 50ì¤„ì˜ ì½”ë“œê°€ ì ˆì•½ë  ê²ƒì…ë‹ˆë‹¤.

---

## ğŸ“š ì¶œì²˜

</div>
